<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css media=all><title>braveheat.xyz | 使用Milvus搭建一个古诗词搜索引擎</title></head><body><div id=container><header class=site-header><h1 class=site-title><a href=/>braveheat.xyz</a></h1></header><hr class=site-header-bottom><div id=content><div class=main role=main><article role=article class=article itemscope itemtype=http://schema.org/BlogPosting><header class=header><h1 class=title itemprop="name headline">使用Milvus搭建一个古诗词搜索引擎</h1><span class=meta><time class=date datetime=2022-05-15T18:59:59+07:00 itemprop=datePublished>2022/05/15</time></span>
<span class=tags><a class=tag href=/tags/ann/><i class="fas fa-tag"></i>
#ann</a>
<a class=tag href=/tags/demo/><i class="fas fa-tag"></i>
#demo</a></span></header><p>作为熟悉向量数据库的一部分，这两天自己手写了一个 demo。Milvus 本身提供了很多不错的例子，但我还是想自己从头做一个。本文是开发过程的记录，心急的可以直接去看完整的<a href=https://github.com/seth-hg/chinese-poetry-search>项目代码</a>。</p><h2 id=准备工作>准备工作</h2><p>需要以下软件：</p><ul><li>docker 和 docker-compose，用于部署 Milvus</li><li>sqlite3，用于存储向量之外的数据</li><li>Python 3.7 或以上版本</li><li>torch 和 transformers，用于 BERT 模型</li><li>bottle，用于开发一个简单 Web 查询服务</li><li>pymilvus，Milvus 的 Python SDK</li><li>milvus-cli，Milvus 命令行工具</li></ul><p>首先需要部署 Milvus 服务。由于数据量不是很大，因此使用 standealone 模式部署一个单节点服务就可以满足需求。下载 <a href=https://github.com/milvus-io/milvus/releases/download/v2.0.2/milvus-standalone-docker-compose.yml>milvus-standalone-docker-compose.yaml</a> 文件到部署目录，然后执行如下命令启动服务：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker-compose up -d
</span></span></code></pre></div><p>服务启动后 Milvus 的数据会存储在当前目录下的 volumes 子目录里，要确保有足够的存储空间。</p><p>也可以顺便部署一个 Milvus 的 Web 前端 Attu：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker run -p 8000:3000 -e HOST_URL=http://{ your machine IP }:8000 -e MILVUS_URL={your machine IP}:19530 zilliz/attu:latest
</span></span></code></pre></div><p>接下来用 pip 安装需要的 Python 库和工具：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pip3 install torch transformers bottle pymilvus milvus-cli
</span></span></code></pre></div><p>本文使用的数据集是 GitHub 上的<a href=https://github.com/chinese-poetry/chinese-poetry>中文诗歌古典文集数据库</a>，把整个仓库 clone 到项目目录下。</p><p>NLP 模型使用清华大学提供的预训练模型<a href=https://github.com/THUNLP-AIPoet/BERT-CCPoem>BERT-CCPoem</a>，这个模型也是针对中文古诗词的，正好适合这个 demo。下载模型，并解压到项目目录下。</p><h2 id=数据向量化>数据向量化</h2><p>原始数据集里的诗歌已经整理成了 JSON 格式，不需要再做额外的处理。下面是其中一首诗：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;玄都觀&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;author&#34;</span><span class=p>:</span> <span class=s2>&#34;徐氏&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;biography&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;paragraphs&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;登尋丹壑到玄都，接日紅霞照座隅。&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;即向周回岩下看，似看曾進畫圖無。&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;notes&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;volume&#34;</span><span class=p>:</span> <span class=s2>&#34;卷九&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;no#&#34;</span><span class=p>:</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>我们主要关注 paragraphs 字段，这里已经把诗歌分成了段落，我们把这些段落提取出来，每个段落转成一个向量用于检索，并建立向量到诗词和段落的映射关系。下面是关键的代码片段：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>    <span class=n>vector_writer</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>writer</span><span class=p>(</span><span class=n>vector_output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>vector_writer</span><span class=o>.</span><span class=n>writerow</span><span class=p>([</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;feature&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>content_writer</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>writer</span><span class=p>(</span><span class=n>content_output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>content_writer</span><span class=o>.</span><span class=n>writerow</span><span class=p>([</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>vector2poem_writer</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>writer</span><span class=p>(</span><span class=n>vector2poem_output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>vector2poem_writer</span><span class=o>.</span><span class=n>writerow</span><span class=p>([</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;poem&#34;</span><span class=p>,</span> <span class=s2>&#34;paragraph&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>vector_id</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>poem_id</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>data_file</span> <span class=ow>in</span> <span class=n>os</span><span class=o>.</span><span class=n>listdir</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>input</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>input</span> <span class=o>+</span> <span class=s2>&#34;/&#34;</span> <span class=o>+</span> <span class=n>data_file</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>poem_list</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>poem</span> <span class=ow>in</span> <span class=n>poem_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>content_writer</span><span class=o>.</span><span class=n>writerow</span><span class=p>([</span><span class=n>poem_id</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>poem</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>                <span class=n>vectors</span> <span class=o>=</span> <span class=n>embedding</span><span class=o>.</span><span class=n>predict_vec_rep</span><span class=p>(</span><span class=n>poem</span><span class=p>[</span><span class=s2>&#34;paragraphs&#34;</span><span class=p>],</span> <span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                    <span class=n>formatter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>vectors</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>vector2poem_writer</span><span class=o>.</span><span class=n>writerow</span><span class=p>([</span><span class=n>vector_id</span><span class=p>,</span> <span class=n>poem_id</span><span class=p>,</span> <span class=n>idx</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=n>vector_writer</span><span class=o>.</span><span class=n>writerow</span><span class=p>([</span><span class=n>vector_id</span><span class=p>,</span> <span class=n>v</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=n>vector_id</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=n>poem_id</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>num</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>poem_id</span> <span class=o>&gt;=</span> <span class=n>args</span><span class=o>.</span><span class=n>num</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span></code></pre></div><p>这段代码输出 3 个 csv 文件：<code>content.csv</code> 包含了诗词的唯一 id 和 JSON 数据；<code>vectors.csv</code> 包含了向量的唯一 id 和 BERT 模型编码之后的 512 维向量；<code>vector2poem.csv</code> 包含了向量 id 到诗词 id 和段落下标的映射关系。</p><p>全唐诗一共有 4 万多首诗，分成 12 万多个段落，在没有 GPU 加速的情况下，这个转换还是挺慢的。</p><h2 id=导入数据>导入数据</h2><p>转换完数据之后可以开始进行数据导入。首先是<code>vectors.csv</code>导入 Milvus。先创建一个名为 poetry 的 Collection，只要包含一个主键 id 和向量字段 feature 即可，向量字段的维度为 512。主键字段的 Auto ID 要关闭，因为<code>vectors.csv</code>里已经包含了唯一 id。</p><p>接下来可以导入数据到 collection。一开始尝试使用 Attu 的图形界面进行数据导入，UI 还是比较友好的，但是单个文件有 128MB 的限制，而且导入速度很慢，一个 10,000 行的文件(100MB 左右)，要 2 分多钟才能导完。看了一下发现 Milvus 后台服务负载并不高，问题可能出在 Attu 上。后来改用 milvus-cli，从部署 Milvus 的机器上导入，速度就要快很多，而且单个文件最大可以到 500MB。需要注意的是，使用 Attu 导入时，csv 文件可以没有标题行，通过 UI 指定 csv 列和字段的对应关系，但是 milvus_cli 导入时是根据标题行来映射字段的，所以每个文件都要有，并且要跟 collection 保持一致，否则会报 schema 错误。</p><p>导入命令如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># 首先要建立连接
</span></span><span class=line><span class=cl>connect -h localhost -p 19530
</span></span><span class=line><span class=cl>import -c poetry path/to/csv
</span></span></code></pre></div><p>顺便也看了一下 milvus-cli 的实现，其实就是把整个文件读到内存里，然后调用 SDK 的 insert()接口一次，批量插入全部数据。</p><p>导入完成之后还要做 2 件事。一是创建索引，这里选择 HNSW，下面索引参数仅供参考。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>+--------------------------+----------------------+
</span></span><span class=line><span class=cl>| Corresponding Collection | poetry               |
</span></span><span class=line><span class=cl>+--------------------------+----------------------+
</span></span><span class=line><span class=cl>| Corresponding Field      | feature              |
</span></span><span class=line><span class=cl>+--------------------------+----------------------+
</span></span><span class=line><span class=cl>| Index Type               | HNSW                 |
</span></span><span class=line><span class=cl>+--------------------------+----------------------+
</span></span><span class=line><span class=cl>| Metric Type              | L2                   |
</span></span><span class=line><span class=cl>+--------------------------+----------------------+
</span></span><span class=line><span class=cl>| Params                   | M: 16                |
</span></span><span class=line><span class=cl>|                          | - efConstruction: 32 |
</span></span><span class=line><span class=cl>+--------------------------+----------------------+
</span></span></code></pre></div><p>另一件事是 load collection。Milvus 中 collection 只有 load 之后才可以进行查询。</p><p>接下来要把<code>poetry.csv</code>和<code>vector2poem.csv</code>这两个文件导入 sqlite。这里就不解释了，直接放语句：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sqlite3 poetry.db
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sqlite&gt; CREATE TABLE poetry(id INT PRIMARY KEY NOT NULL, content TEXT);
</span></span><span class=line><span class=cl>sqlite&gt; CREATE TABLE vector2poem(id INT PRIMARY KEY NOT NULL, poem INT NOT NULL, paragraph INT NOT NULL);
</span></span><span class=line><span class=cl>sqlite&gt; .mode csv
</span></span><span class=line><span class=cl>sqlite&gt; .import --skip 1 out/content.csv poetry
</span></span><span class=line><span class=cl>sqlite&gt; .import --skip 1 out/vector2poem.csv vector2poem
</span></span></code></pre></div><h2 id=查询代码>查询代码</h2><p>查询逻辑在 query.py 里。下面代码是查询的主要逻辑，VdbClient 和 RdbClient 分别封装了 Milvus（向量数据库）和 sqlite（关系数据库）的查询逻辑，方便替换成其他的数据库实现。query()函数包含了跟实现无关的查询逻辑，即根据输入向量 q，从 VdbClient 查询 K 个相似向量的 id 和 score，然后在用向量 id 去 RdbClient 查诗词信息和段落下标，并将结果拼装到一起返回。</p><p>其实做完第一个版本之后，又做了一个使用<a href=https://github.com/alibaba/proximabilin>达摩院 proxima</a> 的版本，代码在 git 仓库的 proxima 分支。当时更换向量数据库实现的时候，发现原来写的代码耦合太紧，更换起来比较麻烦，才改成现在这样。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>VdbClient</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>collection</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>connections</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>alias</span><span class=o>=</span><span class=s2>&#34;default&#34;</span><span class=p>,</span> <span class=n>host</span><span class=o>=</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>collection</span> <span class=o>=</span> <span class=n>Collection</span><span class=p>(</span><span class=n>collection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>column</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>search_params</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;metric_type&#34;</span><span class=p>:</span> <span class=s2>&#34;L2&#34;</span><span class=p>,</span> <span class=s2>&#34;params&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;ef&#34;</span><span class=p>:</span> <span class=mi>32</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>collection</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>data</span><span class=o>=</span><span class=p>[</span><span class=n>v</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                                         <span class=n>anns_field</span><span class=o>=</span><span class=n>column</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                         <span class=n>param</span><span class=o>=</span><span class=n>search_params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                         <span class=n>limit</span><span class=o>=</span><span class=n>n</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                         <span class=n>expr</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                         <span class=n>consistency_level</span><span class=o>=</span><span class=s2>&#34;Strong&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>ids</span><span class=p>,</span> <span class=n>results</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>distances</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>close</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RdbClient</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>endpoint</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>endpoint</span> <span class=o>=</span> <span class=n>endpoint</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ids</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>endpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;SELECT vector2poem.id AS vid, poetry.id AS pid, &#34;</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;poetry.content AS poem, vector2poem.paragraph AS paragraph &#34;</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;FROM vector2poem,poetry &#34;</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;WHERE vector2poem.id in (</span><span class=si>%s</span><span class=s2>) AND vector2poem.poem=poetry.id;&#34;</span> <span class=o>%</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;,&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=nb>str</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>ids</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>cursor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;vid&#34;</span><span class=p>:</span> <span class=n>row</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;pid&#34;</span><span class=p>:</span> <span class=n>row</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=mi>2</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;paragraph&#34;</span><span class=p>:</span> <span class=n>row</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>close</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>query</span><span class=p>(</span><span class=n>vdb</span><span class=p>,</span> <span class=n>db</span><span class=p>,</span> <span class=n>q</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ids</span><span class=p>,</span> <span class=n>scores</span> <span class=o>=</span> <span class=n>vdb</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;feature&#34;</span><span class=p>,</span> <span class=n>q</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>poem</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>ids</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>poem</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>poem</span><span class=p>[</span><span class=n>idx</span><span class=p>][</span><span class=s2>&#34;score&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>scores</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>poem</span>
</span></span></code></pre></div><p>query.py 里还包含了命令行参数的解析，可以直接用来进行查询：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>./query.py --milvus_host [Milvus服务地址] --milvus_port [Milvus服务端口] -c poetry -q [查询关键词]
</span></span></code></pre></div><h2 id=加个前端>加个前端</h2><p>到这里主要任务已经完成了。为了让这个 demo 看起来更完整，我给它加了一个 web 前端，用 bottle 实现，代码在 svr.py 里。只有一个服务接口 index，通过参数 keyword 传递查询关键字。页面用 bottle 自带的模板进行渲染，加上一些简单的 css 修饰一下。页面上会展示完整的诗词，其中向量检索命中的段落会用橙色标记出来，效果如下图。</p><p><img src=/figures/poetry-search.png alt="poetry search screenshot"></p><h2 id=小结>小结</h2><p>做完这个 demo 之后，我兴致勃勃的试用了很久，总体感觉还是挺惊喜的。毕竟这么一个拿来主义的 toy project 并没有花多少时间，主要是在导数据上走了弯路，浪费了比较多的时间。在这个场景下，向量检索的效果很接近全文索引，但是实现起来却要简单的多（当然前提是踩在别人的肩膀上）。用某些关键词查询的时候，会出现感觉相关度应该更高的段落，向量数据库检索结果里的评分却比较低的情况，这个跟 NLP 模型和向量检索的准确率都有关系。如果系统要做得更加完善，不能仅仅依赖向量检索的结果，毕竟向量检索得到的只是<strong>近似</strong>最近邻，要提高结果质量还需要更精细的筛选和排序，类似搜索引擎和推荐系统里的做法。</p></article></div></div></div></body></html>